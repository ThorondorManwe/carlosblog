---
title: "Bit√°cora del capit√°n: Resolv√≠ un problema de la vida real con Python (enviando mails por SMTP)"
slug: bitacora-del-capitan-problema-de-la-vida-real-con-python-enviando-emails-por-smtp
image: ./bitacora-2.jpg
date: 2022-05-12
author: Carlos Rangel
twitter: https://twitter.com/CarlosRanghul
github: https://github.com/ThorondorManwe
dev: https://dev.to/thorondormanwe
linkedin: https://www.linkedin.com/in/carlos-rangel-931a5470/
series: Bitacora-Python
tags: ['bitacora', 'Python']
excerpt: Te cuento c√≥mo resolv√≠ un problema de la vida real con Python
---

import * as styles from "../css/postTemplate.module.css"

**Python es el primer lenguaje que aprend√≠ como autodidacta**, que es lo mismo que decirte que es el primer lenguaje que aprend√≠ en serio. Me gusta su simplicidad y 
la forma en que puedes pasar de una abstracci√≥n, es decir, del plan que tienes en tu cabeza para realizar alguna acci√≥n sobre los datos hasta una aplicaci√≥n que 
hace el trabajo por ti. Por eso, aunque JavaScript es el amo supremo del desarrollo web y creo que es la mejor apuesta para vivir de la programaci√≥n, 
siempre ser√© un fiel seguidor de Python y de todo su ecosistema.

Ayer me sali√≥ un trabajo que me tom√≥ desprevenido, pero **sal√≠ victorioso gracias a la ayuda del c√≥digo**.

Suelo ayudar a mi antiguo empleador con la parte de tecnolog√≠a, sobre todo en el √°rea de negocio encargada del E-learning. Una parte se hace con la 
implementaci√≥n de *LMS* (Learning Management System) en WordPress y la otra, m√°s antigua, es con Moodle. En la instalaci√≥n de Moodle tenemos los ex√°menes que 
los estudiantes pueden resolver en l√≠nea. 

Mi ex empleador hace capacitaciones presenciales y despu√©s me pasa las preguntas del examen y las subo a Moodle. El proceso es bastante sencillo:

1. Creo las preguntas en formato *GIFT* dentro de un editor de c√≥digo.
2. Importo las preguntas dentro de un curso de Moodle.
3. Creo la plantilla de certificado que se emitir√° para todos aquellos que resuelvan el cuestionario y obtengan el puntaje necesario.
4. Subo a los usuarios con un documento *.csv*.
5. Env√≠o a los usuarios su usuario, contrase√±a, y la URL con la que podr√°n acceder al examen. En esta parte les mando una redacci√≥n de plantilla y solo sustituyo sus datos, usuario y contrase√±a.

El punto 5, el de **enviar el usuario es el que siempre me ha parecido m√°s tedioso**. Los otros puntos, los de creaci√≥n de cuestionario y subida de usuarios los 
pseudo automatic√© hace tiempo, pero **el env√≠o de correos de forma masiva se me hab√≠a dificultado por a√±os**. En meses recientes aprend√≠ a usar herramientas de 
*email-marketing* como MailChimp, pero creo que usar algo as√≠ para un correo que se enviar√° una sola vez, y para el cual no se desea hacer seguimiento o 
medici√≥n de ninguna clase, es exagerado.

**Por a√±os hab√≠a so√±ado con hacer el env√≠o automatizado de correos con Python**, por una raz√≥n u otra no hab√≠a sido posible para m√≠ hasta ayer, que me puse a enviar 
el primer correo despu√©s de generar las contrase√±as y los usuarios, cuando me di cuenta de que **no deseaba realizar el proceso, de forma manual, para los m√°s de cuarenta usuarios que 
ten√≠a que mandar**.

As√≠ que abr√≠ un editor de c√≥digo, una nueva pesta√±a en el navegador y me puse a trabajar.

Lo primero que hice fue **buscar en [Oreilly Media](https://www.oreilly.com/)** porque es una plataforma que me ha ayudado mucho con otros temas de programaci√≥n como 
JavaScript y React (es muy buena para aprender temas relacionados con tecnolog√≠a, te la recomiendo bastante). Y me encontr√© con algunos indicios:

    "Python has a library for the Simple Mail Transfer Protocol (SMTP) that you can use to send emails:"
    Raspberry Pi Cookbook, 2nd Edition
    Simon Monk

**As√≠ supe que ten√≠a que usar el protocolo SMTP**, el cual me sonaba bastante porque lo hab√≠a usado cuando configuraba clientes de correo para mi trabajo anterior. 
Aunque los c√≥digos que encontr√© en los libros de Oreilly me parecieron bastante buenos, me di cuenta de que **todos usaban Localhost**, lo cual no estaba dentro de mis 
planes, as√≠ que con este indicio me puse a **buscar en Google**.

Encontr√© dos resultados interesantes en **la SERP de Google**:

![Python send email smtp authentication](https://res.cloudinary.com/dc4gpn7f6/image/upload/v1652402409/sickfits/SERP_python_send_email_smtp_authentication_h73oyn.png "Python send email smtp authentication")

El c√≥digo de [codegrepper.com](https://www.codegrepper.com/code-examples/python/python+smtplib.smtp+username+password) es interesante porque ofrece indicios de c√≥mo autenticarse en el servidor de correo. El problema es que este correo manda un mensaje 
sencillo y **no ofrece la oportunidad de a√±adir ‚ÄúSubject‚Äù al mensaje**.

```python
import smtplib

server = smtplib.SMTP_SSL('smtp.gmail.com', 465)
server.login("your username", "your password")
server.sendmail(
  "from@address.com", 
  "to@address.com", 
  "this message is from python")
server.quit()
```

Este c√≥digo manda un mensaje sencillo, pero sin asunto.

Decid√≠ buscar m√°s y prob√© con el otro enlace, el de la **[documentaci√≥n de Python](https://docs.python.org/3/library/smtplib.html "smtplib")**.

Algo que siempre me echa para atr√°s al leer documentaci√≥n de lenguajes de programaci√≥n es la forma en la que est√°n redactados, porque a menudo **incluyen 
codificaciones sin ejemplos concretos de c√≥mo utilizarlas y esto es confuso**. Supongo que con la pr√°ctica se volver√° m√°s f√°cil leer estos documentos.


Para mi suerte, en la parte inferior de la p√°gina encontr√© un enlace para ver ejemplos de c√≥digo. Esta parte fue m√°s sencilla de leer porque solo hay que 
interpretar lo que hace el c√≥digo.

![python docs smtp](https://res.cloudinary.com/dc4gpn7f6/image/upload/v1652402425/sickfits/smtplib3_x2o2ev.png "python docs smtp")

Encontr√© un ejemplo que mandaba mails a varias cuentas a la vez as√≠ que **decid√≠ probarlo en VSCode**.

```python
# Import smtplib for the actual sending function
import smtplib

# And imghdr to find the types of our images
import imghdr

# Here are the email package modules we'll need
from email.message import EmailMessage

me = "<Usuario_de_tu_correo>"
family = ['<Correo_1>', '<Correo_2>', '<Correo_3>']
# Create the container email message.
msg = EmailMessage()
msg['Subject'] = 'Prueba de env√≠o masivo con script Python'
# me == the sender's email address
# family = the list of all recipients' email addresses
msg['From'] = me
msg['To'] = ', '.join(family)
msg.preamble = 'You will not see this in a MIME-aware mail reader.\n'

# Open the files in binary mode.  Use imghdr to figure out the
# MIME subtype for each specific image.
#for file in pngfiles:
#    with open(file, 'rb') as fp:
#        img_data = fp.read()
#    msg.add_attachment(img_data, maintype='image',
#                                 subtype=imghdr.what(None, img_data))

msg.set_content("""\
Buenaventura a todo aquel que lea estos bits convertidos en letras!

Esto es una prueba de correo enviada por el buen Charles, no os asust√©is

[1] https://www.youtube.com/watch?v=MTNsAl0PHrI

--Carlos Rangel
""")

# Send the email via our own SMTP server.
with smtplib.SMTP_SSL('<Puerto_SMTP_de_salida>', 465) as s:
    s.login("<Usuario_de_tu_correo>", "<Contrase√±a_de_tu_correo>")
    s.send_message(msg)
```

**Coment√© las l√≠neas de c√≥digo que env√≠an im√°genes**, pero me gustar√≠a probar despu√©s esta funcionalidad. Hice un env√≠o a tres diferentes cuentas de correo y me di 
cuenta de que funcionaba, pero hab√≠a un peque√±o problema y es que **el receptor ve√≠a a qu√© otras cuentas de correo les hab√≠an mandado mensajes**.

Lo bueno es que ya ten√≠a la oportunidad de a√±adir un asunto al correo.

A partir de aqu√≠ hice algunas pruebas m√°s hasta que **llegu√© a la conclusi√≥n de que era mejor que el programa enviara un solo mensaje**, pero a cada usuario en una 
lista o en un diccionario. Al final us√© diccionarios para definir la informaci√≥n de cada usuario, y los met√≠ todos dentro de una lista. 

**Mi soluci√≥n fue utilizar un for de cero hasta el len -longitud de la lista**, y en cada iteraci√≥n mandar un email con la estructura deseada. 
Para esta prueba hice un texto improvisado y un poema que copi√© de internet para no hacer tan pesado el ejercicio a los receptores (us√© correos de gente que 
conozco para la prueba). **Us√© f-strings para embeber datos de los diccionarios dentro del texto, de esta forma tendr√≠a un mensaje personalizado para cada persona**.
 En el cuerpo del mensaje inclu√≠ un saludo con su nombre y otros datos para hacer prueba. Me di cuenta de que ya estaba listo para mandar los correos.

En la siguiente versi√≥n del programa **utilic√© el mensaje que ten√≠a como machote y le met√≠ los datos de usuario en el texto**.

![mensaje machote](https://res.cloudinary.com/dc4gpn7f6/image/upload/v1652404353/sickfits/mensaje_Original_bhore5.png "mensaje machote")

Yo sol√≠a tomar una tabla de excel con los usuarios, de all√≠ copiaba el correo y abr√≠a Outlook. En el cuerpo del mensaje pegaba el machote desde un documento de
 Word y despu√©s sustituir los datos como el usuario y la contrase√±a que aparecen en la tabla. Al final pon√≠a el correo del usuario y lo mandaba con copia para 
 mi ex empleador. Todo este proceso me parec√≠a tedioso y m√°s cuando se trataba de m√°s de diez usuarios.

Ahora, despu√©s de unos minutos de investigaci√≥n y pruebas **estaba frente a un c√≥digo en Python que potencialmente podr√≠a hacer todo este proceso por m√≠**.

Decid√≠ que pod√≠a personalizarlo todav√≠a m√°s por lo que inclu√≠ el nombre del usuario en el ‚ÄúSubject‚Äù del correo:

```python
msg['Subject'] = f'Acceso al cuestionario de XXXXXXXXX para {mensajeNombre} {mensajeApellido}'
```

```python
# Prepara todo para mandar mail
# Import smtplib for the actual sending function
import smtplib

# And imghdr to find the types of our images
import imghdr

# Here are the email package modules we'll need
from email.message import EmailMessage


# Manda mail en loop a cada miembro de la lista - diccionario
# lista de diccionarios
# Reccorre cada usuario en la lista y obtiene los datos de su diccionario, usa esos datos para el mensaje del correo
# Manda un mensjae de correo por usuario con copia para Antiguo Empleador

listaUsuarios = [
    {
    'usuario': '<Correo_Usuario>', 
    'nombre': '<Nombre_Usuario>', 
    'apellido': '<Apellido_Usuario>', 
    'password': '<Password_Usuario>', 
    'email': '<Correo_Usuario>', 
    'curso': '<Curso_Usuario>'
    },
    [M√°s filas iguales]
]


for i in range(len(listaUsuarios)):
    print(listaUsuarios[i])
    mensajeUsuario = f"{listaUsuarios[i]['usuario']}"
    mensajeNombre = f"{listaUsuarios[i]['nombre']}"
    mensajeApellido = f"{listaUsuarios[i]['apellido']}"
    mensajeCorreo = f"{listaUsuarios[i]['email']}"
    mensajeContrase√±a = f"{listaUsuarios[i]['password']}"
    print(mensajeUsuario)
    print(mensajeNombre)
    print(mensajeApellido)
    print(mensajeCorreo)
    print(mensajeContrase√±a)

    #Aqu√≠ manda un mensaje a cada usaurio
    me = "<Usuario_de_tu_correo>"
    
    # Create the container email message.
    msg = EmailMessage()
    msg['Subject'] = f'Acceso al cuestionario de XXXXXXXXX para {mensajeNombre} {mensajeApellido}'

    msg['From'] = me
    msg['To'] = mensajeCorreo
    msg['CC'] = "<Correo_al_que_llega_la_copia>"
    msg.preamble = 'You will not see this in a MIME-aware mail reader.\n'

    msg.set_content(f"""\
        Hola {mensajeNombre} {mensajeApellido},


        Buenas noches.

        Te comparto tu usuario y contrase√±a para la plataforma E-learning donde podr√°s acceder 
        al cuestionario del Curso "XXXXXXXXXXXXXXXXXXXXXX"

        Tus datos de acceso:

        Usuario: {mensajeUsuario}
        Contrase√±a: {mensajeContrase√±a}


        Puedes acceder a la plataforma mediante la siguiente liga: 

        [Texto del Link] <URL>

        
        Cualquier duda sobre el uso de la misma se puede resolver conmigo, en este correo.

        Saludos cordiales


        --Carlos Rangel
        """)

    # Send the email via our own SMTP server.
    with smtplib.SMTP_SSL('<Puerto_SMTP_de_salida>', 465) as s:
         s.login("<Usuario_de_tu_correo>", "<Contrase√±a_de_tu_correo>")
         s.send_message(msg)
```

Ya estaba casi listo para resolver la tarea hasta que me di cuenta de que como hab√≠a hecho mi c√≥digo necesitaba una lista de diccionarios con los datos de cada usuario dentro, 
y los datos de mis usuarios estaban en un .csv, as√≠ que **podr√≠a copiar a mano cada pedazo de informaci√≥n, o bien, ya que estaba con el esp√≠ritu de programador, 
deb√≠a encontrar una forma de capturar todos los datos del .csv dentro de un diccionario para despu√©s usarlo en mi programa**.

As√≠ que me sumerg√≠ de nuevo en Google y al buscar ‚Äúread csv python‚Äù me encontr√© con un resultado muy interesante.


![Python CSV](https://res.cloudinary.com/dc4gpn7f6/image/upload/v1652402413/sickfits/buscarPythoncsv_smwnmh.png "Python CSV SERP")

Un tutorial de [Real Python](https://realpython.com/python-csv/) que te ense√±a c√≥mo leer *.csv*, as√≠ que copi√© el c√≥digo en el editor y me puse a modificarlo.

En resumen el c√≥digo abre un .csv, despu√©s recorre cada fila con un for y captura los datos de cada columna dentro de un diccionario que llam√© ‚Äúdict‚Äù. 
Despu√©s usa el m√©todo .append de las listas para meter cada diccionario dentro de la lista ‚Äúusuarios‚Äù.

Las tres √∫ltimas l√≠neas del c√≥digo guardan esta lista ‚Äúusuarios‚Äù dentro de un .txt llamado ‚Äúusuarios.txt‚Äù

```python
import csv
 
usuarios = []
 
with open('usuarios_cuestionario.csv') as csv_file:
    csv_reader = csv.reader(csv_file, delimiter=',')
    line_count = 0
    for row in csv_reader:
        if line_count == 0:
            print(f'Column names are {", ".join(row)}')
            line_count += 1
        else:
            #print(f'\t{row[0]} works in the {row[1]} department, and was born in {row[2]}.')
            # Aqu√≠ hacemos el diccionario para cada usuario
            dict = {
                "usuario": row[0], 
                "nombre": row[1], 
                "apellido": row[2], 
                "password": row[3], 
                "email": row[4], 
                "curso": row[5]
                }
            usuarios.append(dict)
            line_count += 1
    print(f'Processed {line_count} lines.')
    print(usuarios)
 
    usuariosFile = open('usuarios.txt', 'w')
    usuariosFile.write(str(usuarios))
    usuariosFile.close()
```

Entonces ya **con la lista de diccionarios y los datos de cada usuario puedo enviar los correos**.
La versi√≥n final tiene un **sleep porque el servidor cierra la conexi√≥n si ve demasiados mensajes**.

```python
# Prepara todo para mandar mail
# Import smtplib for the actual sending function
import smtplib

# Here are the email package modules we'll need
from email.message import EmailMessage

import time


# Manda mail en loop a cada miembro de la lista - diccionario
# lista de diccionarios
# Recorre cada usuario en la lista y obtiene los datos de su diccionario, usa esos datos para el mensaje del correo
# Manda un mensaje de correo por usuario con copia para otro correo


# Esta es una lista de ejemplo, usa la que te d√© de resultado en el otro programa
listaUsuarios = [
    {
    'usuario': '<Correo_Usuario>', 
    'nombre': '<Nombre_Usuario>', 
    'apellido': '<Apellido_Usuario>', 
    'password': '<Password_Usuario>', 
    'email': '<Correo_Usuario>', 
    'curso': '<Curso_Usuario>'
    },
    [M√°s filas iguales]
]


for i in range(len(listaUsuarios)):
    print(listaUsuarios[i])
    mensajeUsuario = f"{listaUsuarios[i]['usuario']}"
    mensajeNombre = f"{listaUsuarios[i]['nombre']}"
    mensajeApellido = f"{listaUsuarios[i]['apellido']}"
    mensajeCorreo = f"{listaUsuarios[i]['email']}"
    mensajeContrase√±a = f"{listaUsuarios[i]['password']}"
    print(mensajeUsuario)
    print(mensajeNombre)
    print(mensajeApellido)
    print(mensajeCorreo)
    print(mensajeContrase√±a)

    #Aqu√≠ manda un mensaje a cada usaurio
    me = "<Usuario_de_tu_correo>"
    
    # Create the container email message.
    msg = EmailMessage()
    msg['Subject'] = f'Acceso al cuestionario de XXXXXXXXX para {mensajeNombre} {mensajeApellido}'

    msg['From'] = me
    msg['To'] = mensajeCorreo
    msg['CC'] = "<Correo_al_que_llega_la_copia>"
    msg.preamble = 'You will not see this in a MIME-aware mail reader.\n'

    msg.set_content(f"""\
        Hola {mensajeNombre} {mensajeApellido},


        Buenas noches.

        Te comparto tu usuario y contrase√±a para la plataforma E-learning donde podr√°s acceder al cuestionario del Curso 
        "XXXXXXXXX"

        Tus datos de acceso:

        Usuario: {mensajeUsuario}
        Contrase√±a: {mensajeContrase√±a}


        Puedes acceder a la plataforma mediante la siguiente liga: 

        [Texto de Link] <URL>

        
        Cualquier duda sobre el uso de la misma se puede resolver conmigo, en este correo.

        Saludos cordiales


        --Carlos Rangel
        """)

    # Send the email via our own SMTP server.
    with smtplib.SMTP_SSL('<Puerto_SMTP_de_salida>', 465) as s:
        time.sleep(5)
        s.login("<Usuario_de_tu_correo>", "<Contrase√±a_de_tu_correo>")
        s.send_message(msg)
```

As√≠ que se espera 5 segundos antes de enviar cada mensaje y as√≠ no tuve problemas.


**Como puedes ver a mi programa le falta mucho trabajo**. Le falta importar el diccionario de usuarios sin necesidad de copiarlo a mano dentro del programa. A lo mejor se podr√≠a juntar la l√≥gica
general dentro de un c√≥digo que unifique lo que hace el programa que lee el *.csv* y el programa que env√≠a los correos. Se podr√≠a mandar cada parte a una clase por separado con sus
funciones y despu√©s importarlas en el c√≥digo central.


Pero como te dije, esto es algo que hice para resolver un trabajo que hubiera sido bastante tedioso para m√≠ realizar a mano, y el bonus es que ahora tengo dos programas funcionales para
resolver dos tareas en concreto, ya despu√©s puedo trabajar en las mejoras que tengo en mente.

Mientras trabajaba en esto busqu√© en mis libros de Python c√≥mo se hacen los diccionarios en este lenguaje, porque llevo meses trabajando con JavaScript y no hab√≠a tocado Python hasta ayer. 
Tampoco recordaba bien c√≥mo es el m√©todo para meter datos a una lista (en mi mente era algo relacionado con *push*, pero esto podr√≠a ser porque he estado estudiando GitHub en los √∫ltimos d√≠as).
Aunque algunos podr√≠an decir que mucho de este c√≥digo lo copi√© de la red y tienen raz√≥n, parte del trabajo es identificar qu√© c√≥digo puede servirte, porque esto que te mostr√© es la punta del *iceberg*,
hay mucho c√≥digo que descart√© de un vistazo o despu√©s de correr la primera prueba y ver que no era capaz de enviar un solo correo. 

As√≠ que **interpretar lo que hace un programa para usarlo a tu favor
y resolver el problema que tienes entre manos es parte integral de la programaci√≥n**, as√≠ es como lo veo al menos, por lo que no tengo ning√∫n remordimiento. 


Ten√≠a un problema que resolver,
busqu√© c√≥digo en l√≠nea, lo modifiqu√©, lo combin√© seg√∫n mis necesidades y as√≠ llegu√© a mi soluci√≥n.


Espero que hayas disfrutado esta entrada tanto como yo disfrut√© escribirla, deseo que si tienes un problema similar al m√≠o este c√≥digo te ayude en un futuro. Si tienes algo que decir respecto
a esta u otra entrada o cualquier mensaje relacionad con la tecnolog√≠a, abajo tienes mis redes sociales y tambi√©n puedes ir a la secci√≥n de contacto. Estar√© muy feliz de leerte ü§ñ.